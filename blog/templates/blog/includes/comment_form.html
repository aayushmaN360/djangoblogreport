<!-- File: blog/includes/comment_form.html -->

<div id="top-level-form-container">
    <div id="comment-form-container" class="mb-3">
        <h5 id="comment-form-label">Leave a Comment:</h5>
        
        <!-- The action of this form correctly points to your add_comment view -->
        <form id="main-comment-form" method="post" action="{% url 'add_comment' post.pk %}" class="ajax-comment-form">

            
            <!-- THIS IS THE CRITICAL FIX: The token is now on its own line after the <form> tag -->
            {% csrf_token %}
            
            <input type="hidden" name="parent_id" id="id_parent_id" value="">
            
            {% if form.errors %}
                <div class="alert alert-danger p-2 small">{{ form.text.errors }}</div>
            {% endif %}
            
            <div class="form-group mb-2">
                <!-- This will render your textarea with all its classes and attributes from forms.py -->
                {{ form.text }}
            </div>
            
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button type="submit" class="btn btn-primary btn-sm">Submit</button>
                    <button type="button" class="btn btn-secondary btn-sm d-none" id="cancel-reply-btn">Cancel Reply</button>
                </div>
                <small id="word-count" class="text-muted">0 / 100 words</small>
            </div>
        </form>
    </div>
</div>